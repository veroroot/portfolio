name: Build & Deploy (Pages + PDF)

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ============================
      # 1) Setup Pages
      # ============================
      - name: Setup Pages
        uses: actions/configure-pages@v5     

      # ============================
      # 2) Build GitHub Pages site
      # ============================
      - name: Build GitHub Pages site
        uses: actions/jekyll-build-pages@v1
        with:
          source: .
          destination: ./public

      # ============================
      # 3) Setup Node.js for Puppeteer
      # ============================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ============================
      # 4) Install Puppeteer and dependencies
      # ============================
      - name: Install Puppeteer and system dependencies
        run: |
          # Puppeteer 설치 (로컬)
          npm init -y
          npm install puppeteer
          
          # Chrome/Chromium 실행에 필요한 시스템 라이브러리 설치
          # Ubuntu 24.04에서는 libasound2가 libasound2t64로 변경됨
          sudo apt-get update
          sudo apt-get install -y \
            ca-certificates \
            fonts-liberation \
            libasound2t64 \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libc6 \
            libcairo2 \
            libcups2 \
            libdbus-1-3 \
            libexpat1 \
            libfontconfig1 \
            libgbm1 \
            libgcc1 \
            libglib2.0-0 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libstdc++6 \
            libx11-6 \
            libx11-xcb1 \
            libxcb1 \
            libxcomposite1 \
            libxcursor1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxi6 \
            libxrandr2 \
            libxrender1 \
            libxss1 \
            libxtst6 \
            lsb-release \
            wget \
            xdg-utils

      # ============================
      # 5) Generate PDF from HTML (GitHub Pages 스타일)
      # Jekyll로 빌드된 HTML을 Puppeteer로 PDF 변환
      # ============================
      - name: Generate PDF from HTML
        run: |
          # PDF 생성 스크립트 작성
          cat > generate-pdf.js << 'EOF'
          const puppeteer = require('puppeteer');
          const http = require('http');
          const fs = require('fs');
          const path = require('path');
          
          (async () => {
            // 간단한 HTTP 서버 시작 (리소스 로드를 위해)
            const publicDir = path.join(process.cwd(), 'public');
            const server = http.createServer((req, res) => {
              let filePath = path.join(publicDir, req.url === '/' ? '/README.html' : req.url);
              
              // index.html fallback
              if (!fs.existsSync(filePath) && req.url === '/') {
                filePath = path.join(publicDir, 'index.html');
              }
              
              if (fs.existsSync(filePath) && fs.statSync(filePath).isFile()) {
                const ext = path.extname(filePath);
                const contentType = {
                  '.html': 'text/html',
                  '.css': 'text/css',
                  '.js': 'application/javascript',
                  '.png': 'image/png',
                  '.jpg': 'image/jpeg',
                  '.jpeg': 'image/jpeg',
                  '.gif': 'image/gif',
                  '.svg': 'image/svg+xml'
                }[ext] || 'application/octet-stream';
                
                res.writeHead(200, { 'Content-Type': contentType });
                fs.createReadStream(filePath).pipe(res);
              } else {
                res.writeHead(404);
                res.end('Not found');
              }
            });
            
            await new Promise((resolve) => {
              server.listen(8080, () => {
                console.log('Server started on port 8080');
                resolve();
              });
            });
            
            // Puppeteer로 PDF 생성
            const browser = await puppeteer.launch({
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            const page = await browser.newPage();
            
            // 로컬 서버의 URL로 접근
            await page.goto('http://localhost:8080/', { 
              waitUntil: 'networkidle0', 
              timeout: 60000 
            });
            
            // PDF 생성 옵션
            await page.pdf({
              path: 'portfolio.pdf',
              format: 'A4',
              printBackground: true,
              margin: {
                top: '20mm',
                right: '15mm',
                bottom: '20mm',
                left: '15mm'
              }
            });
            
            await browser.close();
            server.close();
            console.log('PDF generated successfully');
          })();
          EOF
          
          # 스크립트 실행
          node generate-pdf.js

      # ============================
      # 6) Copy PDF to public root
      # ============================
      - name: Copy PDF to public root
        run: |
          sudo chown -R $USER:$USER public
          cp portfolio.pdf public/portfolio.pdf

      # ============================
      # 7) Upload artifact for Pages
      # ============================
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
